rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------- HELPERS ---------- */

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated()
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.accountType == "admin";
    }

    /* ---------- USERS ---------- */

    match /users/{userId} {
      allow read: if true;

      allow create: if isOwner(userId)
        && request.resource.data.email == request.auth.token.email;

      // Profile updates (non-sensitive fields) - owner only
      allow update: if isOwner(userId)
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['name', 'bio','upiId', 'profilePhotoUrl', 'phone']);

      // Points updates - any authenticated user can update points
      // Required for social actions (like/unlike) that award points to other users
      allow update: if isAuthenticated()
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['points', 'lastPointsUpdate']);

      // Admin can update accountType (for creator upgrade approval)
      allow update: if isAdmin()
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['accountType']);

      allow delete: if false;

      /* ---- POINTS HISTORY ---- */
      match /pointsHistory/{historyId} {
        allow read: if isOwner(userId);
        allow create: if isAuthenticated();
      }

      /* ---- PAYMENTS ---- */
      match /transactionsReceived/{transactionId} {
        allow read: if isOwner(userId);
        allow write: if isAdmin();
      }

      /* ---- FOLLOWING (reverse index: users/{userId}/following/{creatorId}) ---- */
      match /following/{creatorId} {
        allow read: if true;
        allow create, delete: if isOwner(userId);
      }

      /* ---- DEVICES (FCM tokens) ---- */
      match /devices/{deviceId} {
        allow read: if isOwner(userId);
        allow create, update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }

    /* ---------- POSTS ---------- */

    match /posts/{postId} {
      allow read: if true;

      allow create: if isAuthenticated()
        && request.resource.data.creatorId == request.auth.uid;

      // Owner edits content only
      // Engagement counters updated via actions
      allow update: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid ||
        request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['likeCount', 'commentCount', 'shareCount'])
      );

      // Report system - any authenticated user can increment reportCount
      // and auto-hide posts that exceed the threshold
      allow update: if isAuthenticated()
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['reportCount', 'hidden']);

      // Admin can restore posts (reset reportCount, unhide)
      allow update: if isAdmin()
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['reportCount', 'hidden']);

      allow delete: if resource.data.creatorId == request.auth.uid || isAdmin();

      /* ---- LIKES ---- */
      match /likes/{likeUserId} {
        allow read: if true;
        allow create, delete: if isOwner(likeUserId);
      }

      /* ---- COMMENTS ---- */
      match /comments/{commentId} {
        allow read: if true;

        allow create: if isAuthenticated()
          && request.resource.data.userId == request.auth.uid;

        allow delete: if isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          get(/databases/$(database)/documents/posts/$(postId))
            .data.creatorId == request.auth.uid
        );
      }

      /* ---- REPORTS ---- */
      match /reports/{reportUserId} {
        // Anyone can read reports (needed for hasUserReported check)
        allow read: if true;

        // Users can only create their own report (doc ID = their UID)
        allow create: if isOwner(reportUserId);

        // Only admin can delete reports (during restore)
        allow delete: if isAdmin();
      }
    }

    /* ---------- USERNAMES ---------- */
    match /usernames/{username} {
      allow read: if true;
      allow create: if isAuthenticated();
    }

    /* ---------- PAYMENTS ---------- */
    match /payments/{paymentId} {
      allow read, write: if isAdmin();
    }

    /* ---------- SPONSORS ---------- */
    match /sponsors/{sponsorId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /* ---------- TICKETS (Creator Upgrade Requests) ---------- */
    match /tickets/{ticketId} {
      // Users can read their own tickets, admin can read all
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid || isAdmin()
      );

      // Any authenticated user can create a ticket for themselves
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.status == 'pending';

      // Only admin can update tickets (approve/reject)
      allow update: if isAdmin()
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['status', 'resolvedAt', 'resolvedBy', 'rejectionReason']);

      allow delete: if false;
    }

    /* ---------- CREATORS (public profiles) ---------- */
    match /creators/{creatorId} {
      allow read: if true;

      // Creator profile is auto-created by the app; owner can update own profile
      allow create: if isAuthenticated();

      // Owner can update their own profile fields
      allow update: if isOwner(creatorId)
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['name', 'bio', 'avatarUrl']);

      // Follower count and post count are updated transactionally by any authenticated user
      allow update: if isAuthenticated()
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['followerCount', 'postCount']);

      allow delete: if false;
    }

    /* ---------- FOLLOWERS (per-creator member list) ---------- */
    match /followers/{creatorId}/members/{memberId} {
      allow read: if true;

      // A user can only add/remove themselves as a follower
      allow create, delete: if isOwner(memberId);
    }

    /* ---------- NOTIFICATIONS (in-app, per user) ---------- */
    match /notifications/{userId}/items/{notificationId} {
      // Users can read their own notifications
      allow read: if isOwner(userId);

      // Any authenticated user can create notifications
      // (the post creator writes notification docs for each follower)
      allow create: if isAuthenticated();

      // Users can mark their own notifications as read
      allow update: if isOwner(userId)
        && request.resource.data.diff(resource.data)
          .affectedKeys()
          .hasOnly(['read']);

      allow delete: if isOwner(userId);
    }

    /* ---------- ANALYTICS ---------- */
    match /analytics/{eventId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }
  }
}
